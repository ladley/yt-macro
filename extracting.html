<!DOCTYPE html>
<html>
<head>
  <!-- <script src="https://www.youtube.com/iframe_api"></script> -->

    <script
  src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs="
  crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">

    <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    
    <script>

      function onPlayerReady(event) {
          // 플레이어 준비되면 실행되는 이벤트
          // event.target.playVideo();
          $('#target-time').val(player.getDuration() + " 초")

      }

      function onYouTubeIframeAPIReady(id) {
        player = new YT.Player('player', {
          height: '400px',
          width: '100%',
          videoId: get_video_id($('#target-link').val()),
          // videoId: 'h154bh5TvMI',
          events: {
              'onReady': onPlayerReady,
              'onStateChange': onPlayerStateChange
          }
        });
      }
      
      
      function onPlayerStateChange(event) {
          if(event.data == YT.PlayerState.ENDED) {
              //플레이어 끝나면 실행되는 이벤트
              console.log("ENDED");
          }
              
          if(event.data == YT.PlayerState.PLAYING) {
              //플레이어 재생되면 실행되는 이벤트
              console.log("PLAYING");

          }
              
          if(event.data == YT.PlayerState.PAUSED) {
              //플레이어 일시정지되면 실행되는 이벤트
              console.log("PAUSED");
          }

          if(event.data == YT.PlayerState.BUFFERING){
              //플레이어 버퍼링(로딩)되면 실행되는 이벤트
              console.log("BUFFERING");
          }

          if(event.data == YT.PlayerState.CUED) {
              //플레이어 큐에 올라가면(재생목록에서 다음 실행영상이 되면) 실행되는 이벤트
              console.log("CUED");
          }
      }//onYouTubeIframeAPIReady

    </script>
    <script>
      function get_video_id(y_url){
          if(!y_url){
              alert("유투브 주소를 입력해주세요");
              return false;
          } else {
              //url에서 youtube id만 가져오기
              if(y_url.indexOf("iframe") != -1) {
                  // console.log("is iframe");
                  var temp = y_url.substring(y_url.indexOf("src=")+5,y_url.length);
                  var src = temp.substring(0,temp.indexOf('"'));
                  if(src.indexOf("?") != -1) {
                      // embed/ 부터 ?까지 자름
                      id = src.substring(src.indexOf("embed/")+6,src.indexOf("?"));
                  } else {
                      // embed/ 부터 끝까지 자름
                      id = src.substring(src.indexOf("embed/")+6,src.length);
                  }
              } else {
                  // console.log("is normal");
                  if(y_url.indexOf("watch?v=") != -1) {
                      // console.log("is watch");
                      //watch?v=부터 끝까지 자른 뒤 다시 ?가 있는지 확인해서 ?가 있으면 물음표 전까지 자르고 ? 없으면 그대로 반환
                      var temp = y_url.substring(y_url.indexOf("watch?v=")+8,y_url.length);
                      if(temp.indexOf("?") != -1) {
                          id = temp.substring(0,temp.indexOf("?"));
                      } else {
                          id = temp;
                      }
                  } else {
                      // console.log("is not watch");
                      var temp = y_url.substring(y_url.lastIndexOf("/")+1,y_url.length);
                      if(temp.indexOf("?") != -1){
                          id = temp.substring(0,temp.indexOf("?"));
                      } else {
                          id = temp;
                      }
                  }
              }
          }
          return id;
      }
  </script>
    <style>
      div {
        padding:0.1rem;
      }
    </style>
</head>
<body>
  <div class="container mt-10 border">
    <div class="row">
      <h3 class="text-center">매크로 리소스 추출</h3>
      <div class="col-xs-8">
        <div class="input-group">
          <span class="input-group-addon" id="target-link-label">Target</span>
          <input id="target-link" type="text" class="form-control" placeholder="대상 영상 링크를 입력하세요" aria-describedby="target-link-label" />
        </div>
      </div>
      <div class="col-xs-2">
        <div id="target-load-btn" class="btn btn-primary" >
          가져오기
        </div>
      </div> 
      <div class="col-xs-2"> 
        <div class="input-group">
          <span class="input-group-addon" id="target-time-group">시간</span>
          <input id="target-time" type="text" class="form-control" placeholder="초" aria-describedby="target-time-group" readonly/>
        </div>
      </div>
      <div class="col-xs-12">
        <div id="player"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-8">
        <div class="input-group">
          <span class="input-group-addon" id="source-search-text-label">Source</span>
          <input id="search-word" type="text" class="form-control" placeholder="검색어를 입력하세요" aria-describedby="source-search-text-group" />
        </div>
      </div>
      
      <div class="col-xs-4">
        <div class="dropdown">
          <button id="dropdown-btn" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="true">
            몇번째 영상인가요?
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdown-btn">
            <li class="dropdown-item" role="presentation"><a role="menuitem" tabindex="0" href="#">첫번째</a></li>
            <li class="dropdown-item" role="presentation"><a role="menuitem" tabindex="1" href="#">두번째</a></li>
            <li class="dropdown-item" role="presentation"><a role="menuitem" tabindex="2" href="#">세번째</a></li>
            <li class="dropdown-item" role="presentation"><a role="menuitem" tabindex="3" href="#">네번째</a></li>
          </ul>
        </div>
      </div>
      <div class="col-xs-4">
        <div class="input-group">
          <span class="input-group-addon" id="repeat-label">반복횟수</span>
          <input id="repeat-count" type="number" class="form-control" placeholder="횟수입력" aria-describedby="repeat-label" value="1"/>
        </div>
      </div>
      <div class="col-xs-4">
        <div class="input-group">
          <span class="input-group-addon" id="calculating-label">예상진행시간</span>
          <input id="process-time" type="text" class="form-control" placeholder="" aria-describedby="calculating-label" value="" readonly />
        </div>
      </div>  
    </div>
    <div class="row">
      <div class="col-xs-12">
        <div id="extract-btn" class="btn btn-primary" style="width:100%">
          추출하기
        </div>
      </div>
      <div class="col-xs-12">
        <input type="textarea" rows="5" id="extract-result" class="form-control" />
      </div>
    </div>
  </div>

  <script>
    function calcTime() {
      let video_time = $('#target-time').val().substring(0, $('#target-time').val().length-2)
      let repeat_count = $('#repeat-count').val()
      if(video_time !== ''){
        $('#process-time').val(video_time * repeat_count + " 초")
      }
    }

    $('#repeat-count').on("change", function() {
      calcTime()
    })
    $('#target-load-btn').on("click", function() {
      if(get_video_id($('#target-link').val())) {

        var tag = document.createElement('script');
  
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        $(this).attr('disabled')

        calcTime()
      }
    })
    $('.dropdown-item').on('click', function() {
      
      $('#dropdown-btn').text("몇번째 영상인가요? : " + $(this).find('a').text())
      $('#dropdown-btn').attr('data-index', $(this).find('a').attr('tabindex'))
    })

    $('#extract-btn').on('click', function() {
      let ext_data = {
        target_id : get_video_id($('#target-link').val()),
        target_time : $('#target-time').val().substring(0, $('#target-time').val().length-2),
        source_searchword : $('#search-word').val(),
        order : $('#dropdown-btn').attr('data-index'),
        repeat : $('#repeat-count').val()

      }
      $('#extract-result').val(JSON.stringify(ext_data))
      alert('하단의 결과값을 복사하세요')
    })
  </script>


  <script>
    
  </script>
</body>
</html>